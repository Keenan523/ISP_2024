---
title: "Proper Merge"
author: "Keenan Wallace"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(car)
library(readr)
library(dplyr)
library(tidyr)
library(mosaic)
library(lubridate)
library(tidyverse)
library(randomForest)
library(caret)
```

```{r} 
train <- read_csv("train.csv") 
mapping <- read_csv("weather_station_to_county_mapping.csv")
historical_weather <- read_csv("historical_weather.csv")
client <- read_csv("client.csv")
gas_prices <- read_csv("gas_prices.csv")
electricity_prices <- read_csv("electricity_prices.csv")
forecast_weather <- read_csv("forecast_weather.csv")
```

```{r}
test <- train[train$data_block_id >= 634,]
train <- train[train$data_block_id < 634,]
```

# weather aggregation by region
```{r}
mapping <- na.omit(mapping)
mapping$longitude <- round(mapping$longitude,1)
mapping$latitude <- round(mapping$latitude,1)

```

## merge with forecast weather
```{r}
forecast_weather$latitude <- round(forecast_weather$latitude,1)
forecast_weather$longitude <- round(forecast_weather$longitude,1)
fweather <- left_join(forecast_weather, mapping %>% distinct(longitude, latitude, county), by = c("longitude", "latitude"))
fweather <- na.omit(fweather)
```

## aggregate temperatures by date and region

```{r}
fweather_av <- fweather %>% 
  group_by(origin_datetime, forecast_datetime, county) %>% 
  summarize(temperature = mean(temperature))
fweather_rad <- fweather %>% 
  group_by(origin_datetime, forecast_datetime, county) %>%  
  summarize(direct_solar_radiation = mean(direct_solar_radiation))
fweather_prec <- fweather %>% 
  group_by(origin_datetime, forecast_datetime, county) %>%
  summarize(total_precipitation = mean(total_precipitation))
fweather_dew <- fweather %>% 
  group_by(origin_datetime, forecast_datetime, county) %>%
  summarize(dewpoint = mean(dewpoint))
fweather_data_id <- fweather %>% 
  group_by(origin_datetime) %>%
  summarize(data_block_id = mean(data_block_id))
fweather_av$direct_solar_radiation <- fweather_rad$direct_solar_radiation
fweather_av$total_precipitation <- fweather_prec$total_precipitation
fweather_av$dewpoint <- fweather_dew$dewpoint
fweather_av <- left_join(fweather_av, fweather_data_id, by = "origin_datetime")
fweather_av <- left_join(fweather_av, fweather %>% distinct(origin_datetime, hours_ahead, forecast_datetime), by = c("origin_datetime", "forecast_datetime"))
```

# Testing data

## weather merge (forecast)
note: later would like to sort so that each data block only contains forcast data for the hours of the next data which it will be predicting, rather than the full 48 hours
(keep data up-to-date with the most recent weather info, eliminate duplicates)
use hours_ahead
```{r}
test_weather <- fweather_av[fweather_av$data_block_id >= 634,]
test_weather <- test_weather %>% rename(datetime = forecast_datetime)
test <- left_join(test, test_weather, by = c("data_block_id", "datetime", "county"))
#test<- test[test$hours_ahead == 22:45,]#somehow it seems that the hours ahead are already correct without my intervention... very well
```
nrow = 12480
na = 1152


## client
```{r}
test <- left_join(test, client %>% distinct(data_block_id, is_business, county, product_type, eic_count, installed_capacity), by = c("data_block_id", "is_business", "product_type", "county"))
```


## gas prices
```{r}
test <- left_join(test, gas_prices %>% distinct(data_block_id, lowest_price_per_mwh, highest_price_per_mwh), by = "data_block_id")
```

## electricity prices
```{r}
electricity_prices <- separate(electricity_prices, forecast_date, c("date", "time"), sep = " ")
electricity_prices <- electricity_prices[electricity_prices$time == "10:00",]
test <- left_join(test, electricity_prices %>% distinct(data_block_id, euros_per_mwh), by = "data_block_id")
```


```{r}
test <- na.omit(test)
```

Still issues with this:
- many clients seem to have been lost
- each hour is all consumption or all production, not both

# Train

## historical weather aggregation by region

### orgainize mapping file
```{r}
mapping <- na.omit(mapping)
mapping$longitude <- round(mapping$longitude,1)
mapping$latitude <- round(mapping$latitude,1)

```

### merge with historical weather
```{r}
historical_weather$latitude <- round(historical_weather$latitude,1)
historical_weather$longitude <- round(historical_weather$longitude,1)
hweather <- left_join(historical_weather, mapping %>% distinct(longitude, latitude, county), by = c("longitude", "latitude"))
hweather <- na.omit(hweather)
```

### aggregate hist weather by date and region

```{r}
hweather$total_precipitation <- hweather$snowfall/10 + hweather$rain

hweather_av <- hweather %>% 
  group_by(datetime, county) %>% 
  summarize(temperature = mean(temperature))
hweather_rad <- hweather %>% 
  group_by(datetime, county) %>%  
  summarize(direct_solar_radiation = mean(direct_solar_radiation))
hweather_prec <- hweather %>% 
  group_by(datetime, county) %>%
  summarize(total_precipitation = mean(total_precipitation))
hweather_dew <- hweather %>% 
  group_by(datetime, county) %>%
  summarize(dewpoint = mean(dewpoint))
hweather_av$direct_solar_radiation <- hweather_rad$direct_solar_radiation
hweather_av$total_precipitation <- hweather_prec$total_precipitation
hweather_av$dewpoint <- hweather_dew$dewpoint
```

## add weather to train
```{r}
train <- left_join(train, hweather_av, by = c("county", "datetime"))
train <- na.omit(train)
```

## client
```{r}
train$datetime2 <- train$datetime
train <- separate(train, datetime2, c("date", "time"), sep = " ")

train$date <- as.POSIXct(train$date, format = "%Y-%m-%d")

train <- left_join(train, client %>% distinct(date, is_business, county, product_type, eic_count, installed_capacity), by = c("date", "is_business", "product_type", "county"))
```

## gas
```{r}
gas_prices$date <- as.POSIXct(gas_prices$forecast_date, format = "%m/%d/%y")
train <- left_join(train, gas_prices %>% distinct(date, lowest_price_per_mwh, highest_price_per_mwh), by = "date")
```

# electricity
```{r}
electricity_prices <- read_csv("electricity_prices.csv")
electricity_prices$datetime <- as.POSIXct(electricity_prices$forecast_date, format = "%m/%d/%y %H:%M")
electricity_prices$datetime <- electricity_prices$datetime - hours(4) #bc there was a 4 hour gap when merged... Not sure why but this seems to fix it
train <- left_join(train, electricity_prices %>% distinct(datetime, euros_per_mwh), by = "datetime")
```



```{r}
train <- na.omit(train)
```

# export sets

```{r}
write.csv(train, "/Users/kwallace/ISP_2024/data/train_set.csv", row.names=FALSE)
write.csv(test, "/Users/kwallace/ISP_2024/data/test_set.csv", row.names=FALSE)
```


```{r}
test_t <- test %>% 
  group_by(county, is_business, product_type, data_block_id, datetime) %>%
  summarize(count = n())
```

```{r}
trainlm <- lm(target ~ as.factor(is_business) + temperature + direct_solar_radiation + total_precipitation + dewpoint + eic_count + installed_capacity + lowest_price_per_mwh + euros_per_mwh, data = train[train$is_consumption == 1,])
summary(trainlm)
```
```{r}
predicted <- predict(trainlm, newdata = test_set %>% filter(is_consumption == 1) %>% select(is_business, temperature,direct_solar_radiation, total_precipitation, dewpoint, eic_count, installed_capacity, lowest_price_per_mwh, euros_per_mwh, is_consumption))
actual <- test[test$is_consumption == 1,]$target

data.frame(actual,predicted)
plot(actual ~ predicted)

mae <- (1/length(actual))*sum(abs(actual - predicted))


```
mae = 451.6215

```{r}


trainlm_p <- lm(target ~ as.factor(is_business) + as.factor(product_type)+ temperature + direct_solar_radiation + total_precipitation + dewpoint + eic_count + installed_capacity + lowest_price_per_mwh + euros_per_mwh, data = train[train$is_consumption == 0,])

train2 <- scale(model.matrix(trainlm_p)[,-1], center = F)

trainlm_p2 <- lm(train_set[train_set$is_consumption == 0,]$target ~ train2)

predicted_p <- predict(trainlm_p, newdata = test %>% filter(is_consumption == 0) %>% select(is_business, temperature,direct_solar_radiation, total_precipitation, dewpoint, eic_count, installed_capacity, lowest_price_per_mwh, euros_per_mwh, is_consumption, product_type))

actual_p <- test[test$is_consumption == 0,]$target

mae_p <- (1/length(actual))*sum(abs(actual_p - predicted_p))
mae_p



```


```{r}
trainlm_p3 <- lm(target ~ temperature + direct_solar_radiation + dewpoint + eic_count + installed_capacity, data = train_set[train_set$is_consumption == 0,])

predicted_p3 <- predict(trainlm_p3, newdata = test_set %>% filter(is_consumption == 0) %>% select(temperature, direct_solar_radiation, dewpoint, eic_count, installed_capacity))

actual_p3 <- test_set[test_set$is_consumption == 0,]$target

mae_p3 <- (1/length(actual))*sum(abs(actual_p3 - predicted_p3))
mae_p3
```
plot(trainlm_p, which = 1)

## is_consumption as factor
```{r}
trainlm <- lm(target ~ as.factor(is_business) + as.factor(is_consumption) + temperature + direct_solar_radiation + total_precipitation + dewpoint + eic_count + installed_capacity + lowest_price_per_mwh + euros_per_mwh, data = train)

predicted <- predict(trainlm, newdata = test %>% select(is_business, temperature,direct_solar_radiation, total_precipitation, dewpoint, eic_count, installed_capacity, lowest_price_per_mwh, euros_per_mwh, is_consumption))

actual <- test$target

data.frame(actual,predicted)
plot(actual ~ predicted)

mae <- (1/length(actual))*sum(abs(actual - predicted))


```
mae = 460.047

## w log
```{r}
trainlm <- lm(log(target+0.5) ~ as.factor(is_business) + as.factor(is_consumption) + as.factor(product_type) + temperature + direct_solar_radiation + total_precipitation + dewpoint + eic_count + installed_capacity + lowest_price_per_mwh + euros_per_mwh, data = train)

predicted <- predict(trainlm, newdata = test %>% select(is_business, temperature,direct_solar_radiation, total_precipitation, dewpoint, eic_count, installed_capacity, lowest_price_per_mwh, euros_per_mwh, is_consumption, product_type))

mae <- (1/length(actual))*sum(abs(actual - predicted))
```
mae = 390.6284

## w reciprocal transformation
```{r}
trainlm <- lm(1/(target+.5) ~ as.factor(is_business) + as.factor(is_consumption) + as.factor(product_type) + temperature + direct_solar_radiation + total_precipitation + dewpoint + eic_count + installed_capacity + lowest_price_per_mwh + euros_per_mwh, data = train)

predicted <- predict(trainlm, newdata = test %>% select(is_business, temperature,direct_solar_radiation, total_precipitation, dewpoint, eic_count, installed_capacity, lowest_price_per_mwh, euros_per_mwh, is_consumption, product_type))

mae <- (1/length(actual))*sum(abs(actual - predicted))
plot(trainlm, which = 1)
```
w recip mae = 395.1988

## w exp
```{r}
trainlm <- lm(target ~ as.factor(is_business) + as.factor(is_consumption) + as.factor(product_type) + temperature + direct_solar_radiation + total_precipitation + dewpoint + eic_count + installed_capacity + lowest_price_per_mwh + euros_per_mwh, data = train)

predicted <- predict(trainlm, newdata = test %>% select(is_business, temperature,direct_solar_radiation, total_precipitation, dewpoint, eic_count, installed_capacity, lowest_price_per_mwh, euros_per_mwh, is_consumption, product_type))

mae <- (1/length(actual))*sum(abs(actual - predicted))
```

## randomForest

set dummies
```{r}
library(caret)

# Identify categorical variables (replace 'is_business', 'is_consumption', etc. with your actual categorical variable names)
cats <- c("is_business", "is_consumption")

# Create a formula for dummyVars
formula <- as.formula(paste("~ ."))

# Add the categorical variables to the formula
for (cat in cats) {
  formula <- update.formula(formula, as.formula(sprintf(". + %s", cat)))
}

# Use dummyVars to encode categorical variables
dummy_data <- dummyVars(formula, data = train[, names(train) %in% c(cats, colnames(train))])
train_wd <- predict(dummy_data, newdata = train)
```

```{r}
#random smaller train
set.seed(43)
production <- train[train$is_consumption ==1,]
smol_index <- sample(nrow(train), size = 50000)  
small_train <- train[smol_index, ]

trainrf <- randomForest(target ~ is_consumption + is_business + temperature + direct_solar_radiation + total_precipitation + dewpoint + eic_count + installed_capacity + lowest_price_per_mwh + euros_per_mwh, data = small_train)

predicted <- predict(trainrf, newdata = test %>% select(is_consumption, is_business, temperature,direct_solar_radiation, total_precipitation, dewpoint, eic_count, installed_capacity, lowest_price_per_mwh, euros_per_mwh))

actual = test$target

mae <- (1/length(actual))*sum(abs(actual - predicted))
```

mae = 262.1787
worse than proper_merge2



